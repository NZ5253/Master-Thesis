# Curriculum Learning Configuration for Parallel Parking RL
# Progressive difficulty matching MPC Phase structure

curriculum:
  # ============================================================
  # PHASE 1: Foundation - Fixed spawn, fixed bay (EASIEST)
  # ============================================================
  phase1_foundation:
    name: "Phase 1: Foundation - Fixed Everything"
    description: "Learn basic parking with no randomization. Car always spawns at same position, bay is fixed."

    timesteps: 150000000  # 15M steps
    success_threshold: 0.85  # 85% success rate to advance

    env_config:
      parallel:
        parking:
          bay:
            center_x: 0.0
            center_x_min: 0.0      # IMPORTANT: lock randomization keys
            center_x_max: 0.0
            center_y: 0.13
            center_y_min: 0.13
            center_y_max: 0.13
            yaw: 0.0               # Fixed yaw
            # NO randomization ranges

        spawn_lane:
          # Fixed spawn position (no randomization)
          y_offset_from_bay: 0.83
          y_jitter: 0.0            # No jitter
          yaw: 0.0
          yaw_jitter: 0.0          # No jitter
          x_min_offset: 1.20       # Fixed distance
          x_max_offset: 1.20       # Same as min = no randomization

        obstacles:
          neighbor:
            w: 0.36
            h: 0.26
            offset: 0.54
            pos_jitter: 0.0        # Fixed neighbors
          random:
            num_min: 0
            num_max: 0             # No random obstacles
        
        # Allow full steering range so learning the correct arc is possible
        action_scale:
          steer: 1.0
          accel: 1.0

        # --- PHASE 1 SPECIFIC FIXES ---
        success:
          # Make Phase 1 learnable; tighten later phases
          along_tol: 0.20
          lateral_tol: 0.20
          yaw_tol: 0.20
          v_tol: 0.20
          # Reward-only proximity gate: MUST be below natural slot clearance (~0.18m)
          safe_dist: 0.12

        reward:
          # Stop fighting the correct solution in Phase 1
          prox_w: 0.0
          prox_hard: 0.0

          # Avoid over-penalizing fine corrections early (Gym wrapper handles this if needed)
          action_smooth_w: 0.0
          smooth_w_far: 0.0
          smooth_w_near: 0.0

          # Remove near-goal freeze (force movement closer to goal)
          stall_pos_err: 0.35
          stall_penalty: -0.08  # punish stopping while far

          # Stronger lateral shaping
          k_lat_progress: 10.0
          lat_w: 0.12
          
          # Tighter margin for entry bonus
          in_bay_lat_margin: 0.12
          bay_entry_bonus: 8.0

          # Downscale terminal rewards to match PPO value clipping (vf_clip_param=10.0)
          success_reward: 200.0
          collision_penalty: -200.0
          timeout_penalty: -400.0

          # Shaping coefficients
          k_pot: 2.0
          k_pos_progress: 1.2
          k_yaw_progress: 0.15
          distance_w: 0.05
          time_penalty: -0.008
          stall_speed: 0.02

  # ============================================================
  # PHASE 2: Random Spawn - Bay still fixed
  # ============================================================
  phase2_random_spawn:
    name: "Phase 2: Random Spawn Position"
    description: "Bay is fixed, but spawn position varies (x, y, yaw). Learn to approach from different angles."

    timesteps: 40000000  # 40M steps
    success_threshold: 0.80  # 85% success (harder due to randomization)

    env_config:
      parallel:
        parking:
          bay:
            center_x: 0.0
            center_x_min: 0.0      # IMPORTANT: lock randomization keys
            center_x_max: 0.0
            center_y: 0.13
            center_y_min: 0.13
            center_y_max: 0.13
            yaw: 0.0

        spawn_lane:
          y_offset_from_bay: 0.83
          y_jitter: 0.30           # ±30cm lateral (start conservative)
          yaw: 0.0
          yaw_jitter: 0.35         # ±20° yaw (0.35 rad)
          x_min_offset: 0.80       # Wider range
          x_max_offset: 1.60

        obstacles:
          neighbor:
            w: 0.36
            h: 0.26
            offset: 0.54
            pos_jitter: 0.0        # Neighbors still fixed
          random:
            num_min: 0
            num_max: 0

  # ============================================================
  # PHASE 3: Random Bay X Position - Spawn varies
  # ============================================================
  phase3_random_bay_x:
    name: "Phase 3: Random Bay X Position"
    description: "Bay can shift left/right. Spawn still varies. Goal calculation must adapt."

    timesteps: 50000000  # 50M steps
    success_threshold: 0.75  # 80% success

    env_config:
      parallel:
        parking:
          bay:
            center_x_min: -0.25    # Bay can shift ±25cm
            center_x_max: 0.25
            center_y: 0.13         # Y still fixed
            center_y_min: 0.13     # IMPORTANT: prevent base-config Y randomization
            center_y_max: 0.13
            yaw: 0.0

        spawn_lane:
          y_offset_from_bay: 0.83
          y_jitter: 0.35           # Increase jitter slightly
          yaw: 0.0
          yaw_jitter: 0.40         # ±23°
          x_min_offset: 0.70
          x_max_offset: 1.70

        obstacles:
          neighbor:
            w: 0.36
            h: 0.26
            offset: 0.54
            pos_jitter: 0.0
          random:
            num_min: 0
            num_max: 0

  # ============================================================
  # PHASE 4a: Small Bay Y Range (bridge phase)
  # ============================================================
  phase4a_random_bay_y_small:
    name: "Phase 4a: Small Bay Y Variation"
    description: "Bay Y varies ±10cm. Bridge between fixed-Y and full randomization."

    timesteps: 200000000  # 200M steps
    success_threshold: 0.70  # 70% success

    env_config:
      parallel:
        parking:
          bay:
            center_x_min: -0.30
            center_x_max: 0.30
            center_y_min: 0.03     # Small Y range (±10cm from 0.13)
            center_y_max: 0.23
            yaw: 0.0

        spawn_lane:
          y_offset_from_bay: 0.83
          y_jitter: 0.40
          yaw: 0.0
          yaw_jitter: 0.52         # ±30°
          x_min_offset: 0.60
          x_max_offset: 1.80

        obstacles:
          neighbor:
            w: 0.36
            h: 0.26
            offset: 0.54
            pos_jitter: 0.0
          random:
            num_min: 0
            num_max: 0

  # ============================================================
  # PHASE 4: Random Bay Y Position - Full bay randomization
  # ============================================================
  phase4_random_bay_full:
    name: "Phase 4: Full Bay Randomization"
    description: "Bay can be anywhere (X and Y). Spawn varies widely. Must generalize to any bay position."

    timesteps: 550000000  # 550M steps
    success_threshold: 0.70  # 70% success

    env_config:
      parallel:
        parking:
          bay:
            center_x_min: -0.30
            center_x_max: 0.30
            center_y_min: -0.10    # Bay Y can vary
            center_y_max: 0.35
            yaw: 0.0

        spawn_lane:
          y_offset_from_bay: 0.83
          y_jitter: 0.40           # Full jitter
          yaw: 0.0
          yaw_jitter: 0.52         # ±30° full range
          x_min_offset: 0.60
          x_max_offset: 1.80

        obstacles:
          neighbor:
            w: 0.36
            h: 0.26
            offset: 0.54
            pos_jitter: 0.0        # Still no neighbor jitter
          random:
            num_min: 0
            num_max: 0

  # ============================================================
  # PHASE 5: Neighbor Jitter - Add neighbor randomization
  # ============================================================
  phase5_neighbor_jitter:
    name: "Phase 5: Neighbor Position Jitter"
    description: "Neighbors have random ±5cm jitter. Must handle tight/wide gaps."

    timesteps: 60000000  # 35M steps
    success_threshold: 0.65  # 70% success

    env_config:
      parallel:
        parking:
          bay:
            center_x_min: -0.30
            center_x_max: 0.30
            center_y_min: -0.10
            center_y_max: 0.35
            yaw: 0.0

        spawn_lane:
          y_offset_from_bay: 0.83
          y_jitter: 0.40
          yaw: 0.0
          yaw_jitter: 0.52
          x_min_offset: 0.60
          x_max_offset: 1.80

        obstacles:
          neighbor:
            w: 0.36
            h: 0.26
            offset: 0.54
            pos_jitter: 0.05       # ±5cm neighbor jitter
          random:
            num_min: 0
            num_max: 0

  # ============================================================
  # PHASE 6: Random Obstacles - Full challenge (HARDEST)
  # ============================================================
  phase6_random_obstacles:
    name: "Phase 6: Random Obstacles in Environment"
    description: "Full randomization + random obstacles. Maximum difficulty."

    timesteps: 650000000  # 40M steps
    success_threshold: 0.60  # 65% success (hardest phase)

    env_config:
      parallel:
        parking:
          bay:
            center_x_min: -0.30
            center_x_max: 0.30
            center_y_min: -0.10
            center_y_max: 0.35
            yaw: 0.0

        spawn_lane:
          y_offset_from_bay: 0.83
          y_jitter: 0.40
          yaw: 0.0
          yaw_jitter: 0.52
          x_min_offset: 0.60
          x_max_offset: 1.80

        obstacles:
          neighbor:
            w: 0.36
            h: 0.26
            offset: 0.54
            pos_jitter: 0.05
          random:
            num_min: 0
            num_max: 2             # Up to 2 random obstacles
            x_range: [-1.5, 1.5]
            y_range: [-1.5, 1.5]
            w_range: [0.15, 0.30]
            h_range: [0.15, 0.30]
            min_distance_to_goal: 0.50
            min_distance_to_spawn: 0.40

# ============================================================
# Training Configuration per Phase
# ============================================================
training_config:
  # Phase 1: Foundation - Higher learning rate, more exploration
  phase1_foundation:
    lr: 3e-4                    # Higher LR for faster initial learning
    entropy_coeff: 0.02         # More exploration
    train_batch_size: 4000
    num_sgd_iter: 10
    eval_interval: 5            # Evaluate frequently (should learn fast)

  # Phase 2: Random Spawn - Standard settings
  phase2_random_spawn:
    lr: 3e-4
    entropy_coeff: 0.015
    train_batch_size: 4000
    num_sgd_iter: 10
    eval_interval: 10

  # Phase 3: Random Bay X - Standard
  phase3_random_bay_x:
    lr: 3e-4
    entropy_coeff: 0.01
    train_batch_size: 4000
    num_sgd_iter: 10
    eval_interval: 10

  # Phase 4a: Small Bay Y - Bridge phase
  phase4a_random_bay_y_small:
    lr: 3e-4
    entropy_coeff: 0.015
    train_batch_size: 6000
    num_sgd_iter: 12
    eval_interval: 10

  # Phase 4: Random Bay Full - More exploration needed
  phase4_random_bay_full:
    lr: 3e-4
    entropy_coeff: 0.015        # Slightly more exploration
    train_batch_size: 6000      # Larger batch for stability
    num_sgd_iter: 12
    eval_interval: 10

  # Phase 5: Neighbor Jitter - Fine-tuning
  phase5_neighbor_jitter:
    lr: 2e-4                    # Lower LR for fine-tuning
    entropy_coeff: 0.01
    train_batch_size: 6000
    num_sgd_iter: 12
    eval_interval: 10

  # Phase 6: Random Obstacles - Most careful learning
  phase6_random_obstacles:
    lr: 2e-4                    # Lower LR
    entropy_coeff: 0.02         # More exploration for obstacles
    train_batch_size: 8000      # Larger batch for diversity
    num_sgd_iter: 15            # More updates per batch
    eval_interval: 10

# ============================================================
# Curriculum Progression Settings
# ============================================================
progression:
  # How to evaluate if ready to advance to next phase
  evaluation_episodes: 30       # Evaluate on 30 episodes (less noisy than 10)
  consecutive_successes: 5     # Must pass threshold 5 times in a row

  # Checkpoint management
  save_phase_checkpoints: true  # Save checkpoint at end of each phase
  keep_best_only: false         # Keep all phase checkpoints

  # Early stopping
  max_timesteps_per_phase: null  # No hard limit (use timesteps from phase config)
  patience: 5                    # If no improvement for 5 evals, advance anyway

  # Warm start
  warm_start: true              # Load previous phase weights when advancing
  reset_optimizer: false        # Keep optimizer state across phases