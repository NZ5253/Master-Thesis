# curriculum_config_newcar_resume.yaml
#
# RESUME CONFIG: Phase 4 -> Phase 5 (NO jitter).
#
# PREVIOUS FAILURE: Phase 5 tried two simultaneous changes (jitter + tolerance tightening)
# -> policy collapsed. Phase 4b (jitter-only intermediate) was originally added to fix this.
#
# UPDATED FIX: Remove neighbor jitter entirely. Phase 5 now only tightens tolerances
# (one change at a time) which is the safe curriculum principle.
#
# Resume from Phase 4 final_checkpoint (reward ~444):
#   ./resume_phase5_newcar.sh
#
# Or manually:
#   python -m rl.train_curriculum \
#     --curriculum-config rl/curriculum_config_newcar_resume.yaml \
#     --start-phase phase5_tight_tol \
#     --resume-checkpoint checkpoints/newcar/curriculum_20260220_211152/phase4_random_bay_full/final_checkpoint \
#     --train-until-success \
#     --num-workers 4 --num-cpus 8 --num-gpus 1 \
#     --checkpoint-dir checkpoints/newcar

base_config: "config_env_newcar.yaml"

curriculum:
  # ============================================================
  # PHASE 5: Tighten Tolerance ONLY (one change from Phase 4)
  # ============================================================
  # Start from Phase 4 final_checkpoint (reward ~444, ~90%+ success).
  # Only change: tighten along/lateral from 3.2cm -> 2.7cm.
  # No jitter. One change at a time.
  phase5_tight_tol:
    name: "Phase 5: Tighten to 2.7cm (no jitter)"
    description: "One change: tighten tolerances 3.2cm->2.7cm. No neighbor jitter."

    timesteps: 80000000
    success_threshold: 0.80

    env_config:
      parallel:
        parking:
          bay:
            center_x_min: -0.136
            center_x_max: 0.136
            center_y_min: -0.045
            center_y_max: 0.158
            yaw: 0.0

        spawn_lane:
          y_offset_from_bay: 0.665
          y_jitter: 0.320
          yaw: 0.0
          yaw_jitter: 0.52
          x_min_offset: 0.481
          x_max_offset: 1.442

        obstacles:
          neighbor:
            w: 0.15
            h: 0.10
            offset: 0.244
            pos_jitter: 0.0              # No jitter
            curb_gap: 0.023
            curb_thickness: 0.018
          random:
            num_min: 0
            num_max: 0

        # Only change from Phase 4: tighten to 2.7cm
        success:
          along_tol: 0.027
          lateral_tol: 0.027
          yaw_tol: 0.087
          v_tol: 0.025
          safe_dist: 0.054

        reward:
          prox_w: 1.0
          prox_hard: 2.0

          action_smooth_w: 0.010
          smooth_w_far: 0.008
          smooth_w_near: 0.015
          gear_switch_penalty: 0.8
          steer_reversal_penalty: 0.6

          settling_bonus: 2.5
          settling_v_threshold: 0.010
          settling_steer_threshold: 0.05
          unnecessary_movement_penalty: 1.0
          early_termination_enabled: true
          settled_steps_required: 4

          stall_pos_err: 0.045
          stall_penalty: -0.16
          in_bay_lat_margin: 0.045
          in_bay_along_margin: 0.113
          k_lat_progress: 16.0
          lat_w: 0.22
          bay_entry_bonus: 10.0
          k_pot: 3.2
          k_pos_progress: 2.2
          k_yaw_progress: 0.32
          distance_w: 0.05
          time_penalty: -0.008
          stall_speed: 0.02
          success_reward: 200.0
          collision_penalty: -200.0
          timeout_penalty: -400.0

  # ============================================================
  # PHASE 6: Gentle Polish
  # ============================================================
  phase6_random_obstacles:
    name: "Phase 6: Gentle Polish"
    description: "Same tolerances as Phase 5, settle prettier."

    timesteps: 30000000
    success_threshold: 0.80

    env_config:
      parallel:
        parking:
          bay:
            center_x_min: -0.136
            center_x_max: 0.136
            center_y_min: -0.045
            center_y_max: 0.158
            yaw: 0.0

        spawn_lane:
          y_offset_from_bay: 0.665
          y_jitter: 0.320
          yaw: 0.0
          yaw_jitter: 0.52
          x_min_offset: 0.481
          x_max_offset: 1.442

        obstacles:
          neighbor:
            w: 0.15
            h: 0.10
            offset: 0.244
            pos_jitter: 0.0
            curb_gap: 0.023
            curb_thickness: 0.018
          random:
            num_min: 0
            num_max: 0

        success:
          along_tol: 0.027
          lateral_tol: 0.027
          yaw_tol: 0.087
          v_tol: 0.025
          safe_dist: 0.054

        reward:
          prox_w: 1.0
          prox_hard: 2.0
          action_smooth_w: 0.010
          smooth_w_far: 0.008
          smooth_w_near: 0.015
          gear_switch_penalty: 0.8
          steer_reversal_penalty: 0.6
          settling_bonus: 3.0
          settling_v_threshold: 0.008
          settling_steer_threshold: 0.04
          unnecessary_movement_penalty: 1.0
          early_termination_enabled: true
          settled_steps_required: 5
          stall_pos_err: 0.045
          stall_penalty: -0.16
          in_bay_lat_margin: 0.045
          in_bay_along_margin: 0.113
          k_lat_progress: 16.0
          lat_w: 0.22
          bay_entry_bonus: 10.0
          k_pot: 3.2
          k_pos_progress: 2.2
          k_yaw_progress: 0.32
          distance_w: 0.05
          time_penalty: -0.008
          stall_speed: 0.02
          success_reward: 200.0
          collision_penalty: -200.0
          timeout_penalty: -400.0

  # ============================================================
  # PHASE 7: Final Yaw & Settling Precision
  # ============================================================
  phase7_polish:
    name: "Phase 7: Perfect Yaw & Clean Stop"
    description: "Same position tol, tighter yaw (4deg) and velocity."

    timesteps: 50000000
    success_threshold: 0.75

    env_config:
      parallel:
        parking:
          bay:
            center_x_min: -0.136
            center_x_max: 0.136
            center_y_min: -0.045
            center_y_max: 0.158
            yaw: 0.0

        spawn_lane:
          y_offset_from_bay: 0.665
          y_jitter: 0.320
          yaw: 0.0
          yaw_jitter: 0.52
          x_min_offset: 0.481
          x_max_offset: 1.442

        obstacles:
          neighbor:
            w: 0.15
            h: 0.10
            offset: 0.244
            pos_jitter: 0.0
            curb_gap: 0.023
            curb_thickness: 0.018
          random:
            num_min: 0
            num_max: 0

        success:
          along_tol: 0.027
          lateral_tol: 0.027
          yaw_tol: 0.070           # 4 degrees (tighter)
          v_tol: 0.020             # tighter
          safe_dist: 0.054

        reward:
          prox_w: 1.0
          prox_hard: 2.0
          action_smooth_w: 0.010
          smooth_w_far: 0.008
          smooth_w_near: 0.015
          gear_switch_penalty: 0.8
          steer_reversal_penalty: 0.6
          settling_bonus: 3.0
          settling_v_threshold: 0.008
          settling_steer_threshold: 0.04
          unnecessary_movement_penalty: 1.0
          early_termination_enabled: true
          settled_steps_required: 5
          stall_pos_err: 0.045
          stall_penalty: -0.16
          in_bay_lat_margin: 0.045
          in_bay_along_margin: 0.113
          k_lat_progress: 16.0
          lat_w: 0.22
          bay_entry_bonus: 10.0
          k_pot: 3.2
          k_pos_progress: 2.2
          k_yaw_progress: 0.32
          distance_w: 0.05
          time_penalty: -0.008
          stall_speed: 0.02
          success_reward: 200.0
          collision_penalty: -200.0
          timeout_penalty: -400.0

# ============================================================
# Training Configuration
# ============================================================
training_config:
  phase5_tight_tol:
    lr: 1e-4
    entropy_coeff: 0.003
    train_batch_size: 6000
    num_sgd_iter: 15
    eval_interval: 10

  phase6_random_obstacles:
    lr: 1e-4
    entropy_coeff: 0.003
    train_batch_size: 6000
    num_sgd_iter: 15
    eval_interval: 10

  phase7_polish:
    lr: 1e-4
    entropy_coeff: 0.003
    train_batch_size: 6000
    num_sgd_iter: 15
    eval_interval: 10

# ============================================================
# Curriculum Progression Settings
# ============================================================
progression:
  evaluation_episodes: 100
  consecutive_successes: 3

  save_phase_checkpoints: true
  keep_best_only: true

  max_timesteps_per_phase: null
  patience: 999

  warm_start: true
  reset_optimizer: false
